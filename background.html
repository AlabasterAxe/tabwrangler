
<script type="text/javascript">

var tabStarted = new Object();
var TAB_IDS = new Array();
var stayOpenFor = 420000; //7 minutes
//var stayOpenFor = 15000; //DEBUG

function updateTabs(tab) {
    tabStarted[tab.id] = new Date().getTime();
    if ( TAB_IDS.indexOf(tab.id) == -1 ) {
      TAB_IDS.push(tab.id);
    } else {
     //alert("not added, id exists already");
    }
}

function onUpdateAction(tabId,changeInfo,tab) {
    return updateTabs(tab);
}

function onSelectAction(tabId,selectInfo) {
//   alert("selected");
   var tab = new Object();
   tab.id = tabId;
   return updateTabs(tab);
}

function initTabs(tabs) {
  var tl = tabs.length;

  for (var i = 0; i !== tl; i++) {
    var f = tabs[i].favIconUrl;
    var t = tabs[i].title;
    var u = tabs[i].url;
    var tid = tabs[i].id;
    tabStarted[tid] = new Date().getTime();
    TAB_IDS.push(tid);
  }
}

function checkToClose() {
  refreshOptions();
  chrome.tabs.getSelected(null,updateTabs);
  var tabNum = TAB_IDS.length;
  var rightNow = new Date().getTime();
  var toCut = new Array();
  for ( var i=0; i < tabNum; i++ ) {
	var timeGone = parseInt(rightNow) - parseInt(tabStarted[TAB_IDS[i]]);
        if ( timeGone >= stayOpenFor ) {
          chrome.tabs.remove(TAB_IDS[i]);
          toCut.push(i);
        }
  }

  for ( var x=0;x < toCut.length;x++ ) {
     TAB_IDS.splice(toCut[x],1);
  }

}

function refreshOptions() {
  var m = localStorage["minutes_inactive"];
  if ( m ) {
    stayOpenFor = parseInt(m) * 60000;
    //stayOpenFor = 15000; //DEBUG
  }
}

function startup() {
//  alert("starting up");
  refreshOptions();
  chrome.tabs.getAllInWindow(null, initTabs);
  chrome.tabs.onCreated.addListener(updateTabs);

  chrome.tabs.onUpdated.addListener(onUpdateAction);
  chrome.tabs.onSelectionChanged.addListener(onSelectAction);
  window.setInterval(checkToClose,5000);
}



window.onload = startup;


</script>
